<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BI Kalteng Mobile Manager</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <!-- (Tidak perlu import SDK Gemini di browser, AI dipanggil lewat Cloud Run) -->

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f0f4f8; -webkit-tap-highlight-color: transparent; }
        
        /* Hide Scrollbar but keep functionality */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Smooth Scrolling */
        html { scroll-behavior: smooth; }

        /* Loader */
        .loader { border: 3px solid #e2e8f0; border-top: 3px solid #0e7490; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Chat Bubble Animation */
        .chat-enter { animation: slideInUp 0.3s ease-out forwards; }
        .chat-exit { animation: slideOutDown 0.3s ease-in forwards; }
        
        @keyframes slideInUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes slideOutDown { from { transform: translateY(0); opacity: 1; } to { transform: translateY(100%); opacity: 0; } }

        /* Mobile Card Shadow */
        .mobile-card { box-shadow: 0 4px 20px -2px rgba(0, 0, 0, 0.05); }
    </style>
</head>
<body class="text-slate-800 pb-24">

    <!-- HEADER (Sticky) -->
    <header class="fixed top-0 left-0 right-0 bg-white z-40 border-b border-slate-100 px-5 py-4 flex justify-between items-center shadow-sm">
        <div class="flex items-center gap-3">
            <div class="bg-cyan-700 text-white p-2 rounded-lg">
                <i class="ph-bold ph-bank text-xl"></i>
            </div>
            <div>
                <h1 class="text-base font-bold text-slate-800 leading-none">BI Kalteng</h1>
                <p class="text-[10px] text-cyan-600 font-semibold mt-0.5 tracking-wide">Role Model Manager</p>
            </div>
        </div>
        <button onclick="openForm()" class="bg-cyan-50 text-cyan-700 p-2 rounded-full hover:bg-cyan-100 transition active:scale-95">
            <i class="ph-bold ph-plus text-xl"></i>
        </button>
    </header>

    <!-- SPACER for Fixed Header -->
    <div class="h-20"></div>

    <!-- MAIN CONTENT -->
    <main class="px-5 space-y-6">

        <!-- WELCOME SECTION -->
        <div>
            <h2 class="text-lg font-bold text-slate-800">Dashboard Kegiatan</h2>
            <p class="text-xs text-slate-500">Monitoring & Evaluasi Program 2025</p>
        </div>

        <!-- STATS CAROUSEL (Horizontal Scroll) -->
        <div class="flex gap-3 overflow-x-auto no-scrollbar pb-2 snap-x">
            <!-- Total -->
            <div class="snap-start min-w-[140px] bg-white p-4 rounded-2xl border border-slate-100 mobile-card flex flex-col justify-between">
                <div class="flex justify-between items-start">
                    <span class="text-[10px] font-bold text-slate-400 uppercase">Total</span>
                    <i class="ph-fill ph-list-checks text-cyan-500"></i>
                </div>
                <p class="text-2xl font-extrabold text-slate-800 mt-2" id="totalCount">0</p>
            </div>
            <!-- Reach -->
            <div class="snap-start min-w-[140px] bg-white p-4 rounded-2xl border border-blue-50 mobile-card flex flex-col justify-between">
                <div class="flex justify-between items-start">
                    <span class="text-[10px] font-bold text-blue-400 uppercase">Reach</span>
                    <i class="ph-fill ph-globe text-blue-500"></i>
                </div>
                <p class="text-2xl font-extrabold text-blue-600 mt-2" id="reachCount">0</p>
            </div>
            <!-- Depth -->
            <div class="snap-start min-w-[140px] bg-white p-4 rounded-2xl border border-emerald-50 mobile-card flex flex-col justify-between">
                <div class="flex justify-between items-start">
                    <span class="text-[10px] font-bold text-emerald-400 uppercase">Depth</span>
                    <i class="ph-fill ph-student text-emerald-500"></i>
                </div>
                <p class="text-2xl font-extrabold text-emerald-600 mt-2" id="depthCount">0</p>
            </div>
            <!-- Value -->
            <div class="snap-start min-w-[140px] bg-white p-4 rounded-2xl border border-amber-50 mobile-card flex flex-col justify-between">
                <div class="flex justify-between items-start">
                    <span class="text-[10px] font-bold text-amber-400 uppercase">Value</span>
                    <i class="ph-fill ph-star text-amber-500"></i>
                </div>
                <p class="text-2xl font-extrabold text-amber-600 mt-2" id="valueCount">0</p>
            </div>
        </div>

        <!-- CHARTS SECTION -->
        <div class="bg-white p-5 rounded-2xl border border-slate-100 mobile-card">
            <h3 class="text-sm font-bold text-slate-800 mb-4 flex items-center gap-2">
                <i class="ph-duotone ph-chart-bar text-cyan-600"></i> Statistik Bulanan
            </h3>
            <div class="relative w-full h-48">
                <canvas id="timelineChart"></canvas>
            </div>
        </div>

        <!-- FILTERS & SEARCH -->
        <div class="flex gap-2">
            <div class="relative flex-grow">
                <i class="ph-bold ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                <input type="text" id="searchInput" placeholder="Cari..." class="w-full pl-9 pr-4 py-3 bg-white border border-slate-200 rounded-xl text-sm focus:ring-2 focus:ring-cyan-500 outline-none shadow-sm">
            </div>
            <select id="pillarFilter" onchange="renderCards()" class="bg-white border border-slate-200 text-slate-600 text-sm rounded-xl px-3 outline-none shadow-sm">
                <option value="All">Semua</option>
                <option value="Reach">Reach</option>
                <option value="Depth">Depth</option>
                <option value="Value">Value</option>
            </select>
        </div>

        <!-- ACTIVITY CARDS LIST -->
        <div id="cardList" class="space-y-4">
            <!-- Cards will be injected here via JS -->
        </div>

        <!-- FOOTER INFO -->
        <div class="text-center text-slate-400 text-[10px] py-4">
            &copy; 2025 Bank Indonesia Kalteng<br>
            Data tersimpan otomatis di perangkat.
        </div>
    </main>

    <!-- FLOATING CHAT BUTTON -->
    <button onclick="toggleChat()" class="fixed bottom-6 right-5 bg-cyan-700 text-white p-4 rounded-full shadow-lg shadow-cyan-700/30 hover:bg-cyan-800 transition active:scale-90 z-40 flex items-center justify-center">
        <i class="ph-fill ph-chat-teardrop-text text-2xl"></i>
        <span class="absolute -top-1 -right-1 flex h-3 w-3">
          <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
          <span class="relative inline-flex rounded-full h-3 w-3 bg-red-500"></span>
        </span>
    </button>

    <!-- CHATBOT OVERLAY -->
    <div id="chatOverlay" class="fixed inset-0 z-50 hidden flex-col bg-white/95 backdrop-blur-sm sm:max-w-md sm:right-0 sm:left-auto sm:border-l sm:shadow-2xl">
        <!-- Chat Header -->
        <div class="bg-white px-5 py-4 border-b border-slate-100 flex justify-between items-center shadow-sm">
            <div class="flex items-center gap-3">
                <div class="bg-gradient-to-tr from-cyan-600 to-blue-500 p-2 rounded-full text-white">
                    <i class="ph-fill ph-robot text-lg"></i>
                </div>
                <div>
                    <h3 class="font-bold text-slate-800 text-sm">Asisten BI Kalteng</h3>
                    <p class="text-[10px] text-green-500 flex items-center gap-1">
                        <span class="w-1.5 h-1.5 bg-green-500 rounded-full"></span> Online
                    </p>
                </div>
            </div>
            <button onclick="toggleChat()" class="text-slate-400 hover:text-slate-600 p-2">
                <i class="ph-bold ph-x text-xl"></i>
            </button>
        </div>

        <!-- Chat Body -->
        <div id="chatMessages" class="flex-grow overflow-y-auto p-4 space-y-4 bg-slate-50">
            <!-- Intro Message -->
            <div class="flex gap-3">
                <div class="bg-white p-3 rounded-2xl rounded-tl-none shadow-sm text-sm text-slate-600 border border-slate-100 max-w-[85%]">
                    Halo! Saya asisten AI untuk program Role Model BI Kalteng. Saya punya akses ke data kegiatan Anda. Ada yang bisa saya bantu?
                </div>
            </div>
        </div>

        <!-- Chat Input -->
        <div class="p-4 bg-white border-t border-slate-100">
            <div class="flex gap-2">
                <input type="text" id="chatInput" placeholder="Tanya tentang kegiatan..." class="flex-grow px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-cyan-500" onkeypress="handleChatEnter(event)">
                <button onclick="sendChatMessage()" class="bg-cyan-700 text-white p-3 rounded-xl hover:bg-cyan-800 transition shadow-sm active:scale-95 disabled:opacity-50" id="sendBtn">
                    <i class="ph-bold ph-paper-plane-right"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- FORM MODAL (Full Screen on Mobile) -->
    <div id="formModal" class="fixed inset-0 z-50 hidden bg-white">
        <div class="flex flex-col h-full">
            <div class="px-5 py-4 border-b border-slate-100 flex justify-between items-center">
                <h3 class="font-bold text-slate-800 text-lg" id="formTitle">Kegiatan Baru</h3>
                <button onclick="closeForm()" class="text-slate-400 p-2">
                    <i class="ph-bold ph-x text-2xl"></i>
                </button>
            </div>
            
            <form id="activityForm" onsubmit="handleFormSubmit(event)" class="flex-grow overflow-y-auto p-5 space-y-5">
                <input type="hidden" id="editId">
                
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase">Nama Kegiatan</label>
                    <input type="text" id="inpName" required class="w-full mt-1 px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-sm focus:ring-2 focus:ring-cyan-500 outline-none" placeholder="Nama kegiatan...">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs font-bold text-slate-500 uppercase">Pilar</label>
                        <select id="inpPillar" class="w-full mt-1 px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-sm outline-none">
                            <option value="Reach">Reach</option>
                            <option value="Depth">Depth</option>
                            <option value="Value">Value</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-500 uppercase">Status</label>
                        <select id="inpStatus" class="w-full mt-1 px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-sm outline-none">
                            <option value="Direncanakan">Direncanakan</option>
                            <option value="Berjalan">Berjalan</option>
                            <option value="Selesai">Selesai</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase">Output / Target</label>
                    <input type="text" id="inpOutput" required class="w-full mt-1 px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-sm focus:ring-2 focus:ring-cyan-500 outline-none" placeholder="Contoh: Dokumen...">
                </div>

                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase">Waktu</label>
                    <input type="text" id="inpDate" required class="w-full mt-1 px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-sm focus:ring-2 focus:ring-cyan-500 outline-none" placeholder="Bulan...">
                </div>
            </form>

            <div class="p-5 border-t border-slate-100 bg-white">
                <button onclick="document.getElementById('activityForm').requestSubmit()" class="w-full bg-cyan-700 text-white py-3.5 rounded-xl font-bold shadow-lg shadow-cyan-700/20 active:scale-95 transition">
                    Simpan Data
                </button>
            </div>
        </div>
    </div>

    <!-- AI RESULT MODAL (Bottom Sheet Style) -->
    <div id="aiModal" class="fixed inset-0 z-[60] hidden">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onclick="closeAiModal()"></div>
        <div class="absolute bottom-0 left-0 right-0 bg-white rounded-t-3xl shadow-2xl transform transition-transform duration-300 max-h-[85vh] flex flex-col">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <i class="ph-bold ph-sparkle text-cyan-600"></i>
                    <h3 class="font-bold text-slate-800" id="aiModalTitle">AI Result</h3>
                </div>
                <button onclick="closeAiModal()" class="bg-slate-100 p-1 rounded-full"><i class="ph-bold ph-x"></i></button>
            </div>
            
            <div class="flex-grow overflow-y-auto p-6 custom-scrollbar">
                <div id="aiModalLoader" class="flex flex-col items-center py-10">
                    <div class="loader mb-3"></div>
                    <p class="text-xs text-slate-400">Gemini sedang berpikir...</p>
                </div>
                <div id="aiModalContent" class="hidden prose prose-sm max-w-none text-slate-600"></div>
            </div>

            <div class="p-4 border-t border-slate-100">
                <button onclick="copyAiContent()" class="w-full bg-slate-100 text-slate-700 py-3 rounded-xl font-bold hover:bg-slate-200 transition">
                    <i class="ph-bold ph-copy mr-2"></i> Salin Teks
                </button>
            </div>
        </div>
    </div>

    <!-- LOGIC -->
    <script>
        // --- DATASET & STATE ---
        const defaultData = [
            { id: 1, pillar: 'Reach', name: 'Pedoman Role Model BI Kalteng', output: 'Dokumen', date: 'Jan', status: 'Selesai' },
            { id: 2, pillar: 'Reach', name: 'Sosialisasi Cinta Bangga Paham Rupiah', output: 'Event', date: 'Feb', status: 'Selesai' },
            { id: 3, pillar: 'Depth', name: 'Seleksi Role Model', output: 'Shortlist', date: 'Mar', status: 'Direncanakan' },
            { id: 4, pillar: 'Depth', name: 'Training Leadership', output: 'Sertifikat', date: 'Mei', status: 'Direncanakan' },
            { id: 5, pillar: 'Value', name: 'Proyek Perubahan UMKM', output: 'Laporan', date: 'Jun-Okt', status: 'Direncanakan' }
        ];

        let activities = [];
        let chartInstance = null;

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            initChart();
            renderCards();
            updateStats();
            document.getElementById('searchInput').addEventListener('input', renderCards);
        });

        // --- DATA STORAGE ---
        function loadData() {
            const stored = localStorage.getItem('biKaltengMobile');
            activities = stored ? JSON.parse(stored) : JSON.parse(JSON.stringify(defaultData));
        }

        function saveData() {
            localStorage.setItem('biKaltengMobile', JSON.stringify(activities));
            updateStats();
            updateChart();
            renderCards(); // Refresh UI
        }
        
        function restoreDefaultData() {
            if(confirm("Reset data?")) {
                activities = JSON.parse(JSON.stringify(defaultData));
                saveData();
            }
        }

        // --- UI RENDERERS ---
        function updateStats() {
            document.getElementById('totalCount').innerText = activities.length;
            document.getElementById('reachCount').innerText = activities.filter(a => a.pillar === 'Reach').length;
            document.getElementById('depthCount').innerText = activities.filter(a => a.pillar === 'Depth').length;
            document.getElementById('valueCount').innerText = activities.filter(a => a.pillar === 'Value').length;
        }

        function renderCards() {
            const container = document.getElementById('cardList');
            const search = document.getElementById('searchInput').value.toLowerCase();
            const filter = document.getElementById('pillarFilter').value;
            
            container.innerHTML = '';
            
            const filtered = activities.filter(item => {
                const matchSearch = item.name.toLowerCase().includes(search);
                const matchPillar = filter === 'All' || item.pillar === filter;
                return matchSearch && matchPillar;
            });

            if(filtered.length === 0) {
                container.innerHTML = `<div class="text-center py-10 text-slate-400 italic text-sm">Tidak ada kegiatan.</div>`;
                return;
            }

            filtered.forEach(item => {
                // Styling
                let borderClass = 'border-l-4 border-l-slate-300';
                if(item.pillar === 'Reach') borderClass = 'border-l-4 border-l-blue-500';
                if(item.pillar === 'Depth') borderClass = 'border-l-4 border-l-emerald-500';
                if(item.pillar === 'Value') borderClass = 'border-l-4 border-l-amber-500';

                let statusBadge = item.status === 'Selesai' ? 'bg-emerald-100 text-emerald-700' :
                                  item.status === 'Berjalan' ? 'bg-blue-100 text-blue-700' : 'bg-slate-100 text-slate-500';

                const card = `
                    <div class="bg-white rounded-xl p-4 shadow-sm border border-slate-100 ${borderClass} relative">
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-[10px] uppercase font-bold text-slate-400 tracking-wider">${item.pillar}</span>
                            <span class="text-[10px] px-2 py-0.5 rounded-full font-bold ${statusBadge}">${item.status}</span>
                        </div>
                        
                        <h3 class="font-bold text-slate-800 text-base mb-1 pr-8">${item.name}</h3>
                        
                        <div class="text-xs text-slate-500 space-y-1 mb-4">
                            <div class="flex items-center gap-1.5"><i class="ph-bold ph-calendar-blank"></i> ${item.date}</div>
                            <div class="flex items-center gap-1.5"><i class="ph-bold ph-target"></i> ${item.output}</div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="grid grid-cols-2 gap-2 border-t border-slate-50 pt-3">
                            <button onclick="aiDraft(${item.id})" class="flex items-center justify-center gap-1.5 py-2 bg-indigo-50 text-indigo-700 rounded-lg text-xs font-bold active:scale-95 transition">
                                <i class="ph-bold ph-file-text"></i> Draft
                            </button>
                            <button onclick="aiRisk(${item.id})" class="flex items-center justify-center gap-1.5 py-2 bg-rose-50 text-rose-700 rounded-lg text-xs font-bold active:scale-95 transition">
                                <i class="ph-bold ph-shield-warning"></i> Risiko
                            </button>
                        </div>
                        
                        <!-- Menu (Edit/Delete) -->
                        <div class="absolute top-3 right-3 flex gap-2">
                             <button onclick="openForm(${item.id})" class="text-slate-300 hover:text-cyan-600"><i class="ph-bold ph-pencil-simple text-lg"></i></button>
                             <button onclick="deleteActivity(${item.id})" class="text-slate-300 hover:text-red-500"><i class="ph-bold ph-trash text-lg"></i></button>
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', card);
            });
        }

        // --- CRUD LOGIC ---
        function openForm(id = null) {
            const modal = document.getElementById('formModal');
            const title = document.getElementById('formTitle');
            const form = document.getElementById('activityForm');
            modal.classList.remove('hidden');
            
            if(id) {
                const item = activities.find(a => a.id === id);
                title.innerText = "Edit Kegiatan";
                document.getElementById('editId').value = id;
                document.getElementById('inpName').value = item.name;
                document.getElementById('inpPillar').value = item.pillar;
                document.getElementById('inpStatus').value = item.status;
                document.getElementById('inpOutput').value = item.output;
                document.getElementById('inpDate').value = item.date;
            } else {
                title.innerText = "Kegiatan Baru";
                form.reset();
                document.getElementById('editId').value = "";
            }
        }

        window.closeForm = () => document.getElementById('formModal').classList.add('hidden');

        window.handleFormSubmit = (e) => {
            e.preventDefault();
            const idVal = document.getElementById('editId').value;
            const newData = {
                name: document.getElementById('inpName').value,
                pillar: document.getElementById('inpPillar').value,
                status: document.getElementById('inpStatus').value,
                output: document.getElementById('inpOutput').value,
                date: document.getElementById('inpDate').value
            };

            if(idVal) {
                const idx = activities.findIndex(a => a.id == idVal);
                if(idx !== -1) activities[idx] = { ...activities[idx], ...newData };
            } else {
                const newId = activities.length > 0 ? Math.max(...activities.map(a => a.id)) + 1 : 1;
                activities.push({ id: newId, ...newData });
            }
            saveData();
            closeForm();
        }

        window.deleteActivity = (id) => {
            if(confirm("Hapus kegiatan?")) {
                activities = activities.filter(a => a.id !== id);
                saveData();
            }
        }

        // --- CHART JS ---
        function initChart() {
            const ctx = document.getElementById('timelineChart').getContext('2d');
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: getChartData(),
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { 
                        y: { beginAtZero: true, grid: { borderDash: [2, 2] } }, 
                        x: { grid: { display: false } } 
                    }
                }
            });
        }

        function updateChart() {
            if(chartInstance) {
                chartInstance.data = getChartData();
                chartInstance.update();
            }
        }

        function getChartData() {
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Agu', 'Sep', 'Okt', 'Nov', 'Des'];
            const counts = months.map(m => activities.filter(a => a.date.includes(m)).length);
            return {
                labels: months,
                datasets: [{ label: 'Kegiatan', data: counts, backgroundColor: '#0e7490', borderRadius: 4 }]
            };
        }

        // --- GEMINI AI INTEGRATION via CLOUD RUN ---
        async function callGemini(prompt) {
            try {
                const res = await fetch(
                    "https://gemini-backend-977426936394.asia-southeast2.run.app/chat",
                    {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ prompt })
                    }
                );

                const data = await res.json();
                const text =
                    data?.candidates?.[0]?.content?.parts?.[0]?.text ||
                    data?.response?.candidates?.[0]?.content?.parts?.[0]?.text ||
                    "Maaf, tidak ada jawaban dari AI.";

                return text;
            } catch (e) {
                console.error(e);
                return "Maaf, koneksi AI terganggu.";
            }
        }

        // Modal Helpers
        function openAiModal(title) {
            document.getElementById('aiModal').classList.remove('hidden');
            document.getElementById('aiModalTitle').innerText = title;
            document.getElementById('aiModalContent').classList.add('hidden');
            document.getElementById('aiModalLoader').classList.remove('hidden');
        }
        window.closeAiModal = () => document.getElementById('aiModal').classList.add('hidden');
        window.copyAiContent = () => {
            navigator.clipboard.writeText(document.getElementById('aiModalContent').innerText);
            alert("Disalin!");
        };

        // 1. DRAFT PROPOSAL
        window.aiDraft = async (id) => {
            const item = activities.find(a => a.id === id);
            openAiModal(`Draft: ${item.name}`);
            const prompt = `Buatkan kerangka proposal singkat untuk kegiatan BI Kalteng: "${item.name}" (Output: ${item.output}). Sertakan Latar Belakang (konteks Bank Indonesia), Tujuan, dan KPI. Bahasa Indonesia formal.`;
            const res = await callGemini(prompt);
            document.getElementById('aiModalLoader').classList.add('hidden');
            const c = document.getElementById('aiModalContent');
            c.innerHTML = marked.parse(res);
            c.classList.remove('hidden');
        };

        // 2. RISK MITIGATION
        window.aiRisk = async (id) => {
            const item = activities.find(a => a.id === id);
            openAiModal(`Risiko: ${item.name}`);
            const prompt = `Analisis risiko untuk kegiatan BI Kalteng: "${item.name}". Identifikasi Risiko Operasional & Reputasi, serta berikan mitigasinya.`;
            const res = await callGemini(prompt);
            document.getElementById('aiModalLoader').classList.add('hidden');
            const c = document.getElementById('aiModalContent');
            c.innerHTML = marked.parse(res);
            c.classList.remove('hidden');
        };

        // --- CHATBOT LOGIC ---
        const chatHistory = [];

        window.toggleChat = () => {
            const overlay = document.getElementById('chatOverlay');
            if(overlay.classList.contains('hidden')) {
                overlay.classList.remove('hidden');
                overlay.classList.add('flex');
            } else {
                overlay.classList.add('hidden');
                overlay.classList.remove('flex');
            }
        }

        window.handleChatEnter = (e) => {
            if(e.key === 'Enter') sendChatMessage();
        }

        window.sendChatMessage = async () => {
            const input = document.getElementById('chatInput');
            const msg = input.value.trim();
            if(!msg) return;

            // Add User Message
            appendMessage('user', msg);
            input.value = '';
            
            // Context Awareness
            const dataSummary = JSON.stringify(activities.map(a => ({ name: a.name, status: a.status, pillar: a.pillar })));
            
            const prompt = `
                Kamu adalah Asisten AI untuk Bank Indonesia Kalteng.
                Data kegiatan saat ini: ${dataSummary}.
                
                Jawab pertanyaan user ini: "${msg}".
                Jawab dengan singkat, ramah, dan profesional.
            `;

            // Loading Indicator
            const loadId = appendMessage('bot', '...', true);
            
            // Call AI
            const response = await callGemini(prompt);
            
            // Remove Loader & Add Response
            document.getElementById(loadId).remove();
            appendMessage('bot', response);
        }

        function appendMessage(sender, text, isLoader = false) {
            const container = document.getElementById('chatMessages');
            const id = 'msg-' + Date.now();
            
            const align = sender === 'user' ? 'justify-end' : 'justify-start';
            const bg = sender === 'user' ? 'bg-cyan-700 text-white rounded-tr-none' : 'bg-white text-slate-600 border border-slate-100 rounded-tl-none';
            const parsedText = isLoader ? '<div class="flex gap-1"><span class="w-1.5 h-1.5 bg-slate-400 rounded-full animate-bounce"></span><span class="w-1.5 h-1.5 bg-slate-400 rounded-full animate-bounce delay-100"></span><span class="w-1.5 h-1.5 bg-slate-400 rounded-full animate-bounce delay-200"></span></div>' : marked.parse(text);

            const html = `
                <div class="flex ${align} chat-enter" id="${id}">
                    <div class="p-3 rounded-2xl shadow-sm text-sm max-w-[85%] ${bg}">
                        ${parsedText}
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', html);
            container.scrollTop = container.scrollHeight;
            return id;
        }

    </script>
</body>
</html>
